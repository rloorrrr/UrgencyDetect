# -*- coding: utf-8 -*-
"""ê¸´ê¸‰ë„íŒë³„_í›ˆë ¨ìš©_ë¼ë²¨ë§_EDA(Gemini).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YKSupCTp0c6rzeMOqQxhX2DyhmmfPysA
"""

# %% [EDA] 1. ë°ì´í„° ë¡œë”© (ë¼ë²¨ë§ ZIP íŒŒì¼ ì§ì ‘ ì½ê¸°)
import zipfile
import json
from tqdm import tqdm
import pandas as pd
import os
import glob

# 1. êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§ˆìš´íŠ¸ (ì´ë¯¸ ì‹¤í–‰í–ˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥)
from google.colab import drive
drive.mount('/content/drive')

# 2. '2.ë¼ë²¨ë§ë°ì´í„°' í´ë” ê²½ë¡œ ì§€ì •
DRIVE_DATA_ROOT = "/content/drive/MyDrive/project1/Training/2.ë¼ë²¨ë§ë°ì´í„°"

print(f"'{DRIVE_DATA_ROOT}' í´ë”ì—ì„œ ë¼ë²¨ë§ ì••ì¶• íŒŒì¼ ìŠ¤ìº” ì¤‘...")
# í•´ë‹¹ í´ë”ì˜ ëª¨ë“  .zip íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.
zip_file_paths = glob.glob(os.path.join(DRIVE_DATA_ROOT, "*.zip"))

if not zip_file_paths:
    print("âš ï¸ [ê²½ê³ ] ì••ì¶• íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. DRIVE_DATA_ROOT ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
else:
    print(f"-> ì´ {len(zip_file_paths)}ê°œì˜ ë¼ë²¨ë§ ì••ì¶• íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ë°ì´í„° ë¡œë”©ì„ ì‹œì‘í•©ë‹ˆë‹¤.")

    call_rows, utt_rows = [], []

    for zip_path in tqdm(zip_file_paths, desc="ë¼ë²¨ë§ ZIP ì²˜ë¦¬ ì¤‘"):
        try:
            with zipfile.ZipFile(zip_path, 'r') as zf:
                # ZIP íŒŒì¼ ë‚´ì˜ ëª¨ë“  .json íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
                json_files_in_zip = [f for f in zf.namelist() if f.endswith('.json')]

                for json_path in json_files_in_zip:
                    with zf.open(json_path) as json_file:
                        data = json.load(json_file)

                        # --- ë°ì´í„° ì¶”ì¶œ ë¡œì§ ---
                        call_info = {
                            'recordId': data.get('recordId'),
                            'label_path': f"{zip_path}/{json_path}",
                            'gender': data.get('gender'),
                            'sentiment': data.get('sentiment'),
                            'disasterLarge': data.get('disasterLarge'),
                            'disasterMedium': data.get('disasterMedium'),
                            'urgencyLevel': data.get('urgencyLevel'),
                            'n_utterances': len(data.get('utterances', [])),
                            'startAt': data.get('startAt'),
                            'endAt': data.get('endAt')
                        }
                        call_rows.append(call_info)

                        for utt in data.get('utterances', []):
                            utt_rows.append({
                                'recordId': data.get('recordId'),
                                'speaker': utt.get('speaker'),
                                'startAt': utt.get('startAt'),
                                'endAt': utt.get('endAt'),
                                'text': (utt.get('text') or "").strip()
                            })
        except Exception as e:
            print(f"âš ï¸ [ê²½ê³ ] '{zip_path}' ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            continue

    calls_df = pd.DataFrame(call_rows)
    utts_df = pd.DataFrame(utt_rows)

    print("\nğŸ‰ ë°ì´í„° ë¡œë”© ì™„ë£Œ!")
    print(f"ìƒì„±ëœ DataFrame í¬ê¸° -> í†µí™”(calls_df): {calls_df.shape}, ë°œí™”(utts_df): {utts_df.shape}")
    print("\n--- calls_df ë¯¸ë¦¬ë³´ê¸° ---")
    print(calls_df.head())

# %% [EDA] 2. ëŒ€í™” 'í„´(Turn)' ì „í™˜ íšŸìˆ˜ ê³„ì‚°

# 1. ë°œí™” ìˆœì„œ ì •ë ¬
# ê° í†µí™”(recordId) ë‚´ì—ì„œ ë°œí™”ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •í™•í•˜ê²Œ ì •ë ¬í•©ë‹ˆë‹¤.
utts_df_sorted = utts_df.sort_values(by=['recordId', 'startAt']).copy()

# 2. í„´ ì „í™˜ ì—¬ë¶€ ì‹ë³„
# groupby().transform()ì„ ì‚¬ìš©í•´ ê° í†µí™”ë³„ë¡œ ì´ì „ ë°œí™”ì™€ í˜„ì¬ ë°œí™”ì˜ í™”ìê°€ ë‹¤ë¥¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
utts_df_sorted['turn_changed'] = utts_df_sorted.groupby('recordId')['speaker'].transform(
    lambda x: x.ne(x.shift())
)

# 3. ì²« ë°œí™” ì²˜ë¦¬
# ê° í†µí™”ì˜ ì²« ë°œí™”ëŠ” í•­ìƒ ìƒˆë¡œìš´ í„´ì˜ ì‹œì‘ì´ë¯€ë¡œ, Trueë¡œ ê°•ì œ ì§€ì •í•©ë‹ˆë‹¤.
first_utt_indices = utts_df_sorted.groupby('recordId').head(1).index
utts_df_sorted.loc[first_utt_indices, 'turn_changed'] = True

# 4. í†µí™”ë³„ í„´ ì „í™˜ íšŸìˆ˜ ì§‘ê³„
# turn_changedê°€ Trueì¸ ê²½ìš°(ì¦‰, í™”ìê°€ ë°”ë€ ê²½ìš°)ë¥¼ ëª¨ë‘ ë”í•´ í†µí™”ë³„ ì´ í„´ ì „í™˜ íšŸìˆ˜ë¥¼ êµ¬í•©ë‹ˆë‹¤.
turn_counts = utts_df_sorted.groupby('recordId')['turn_changed'].sum().reset_index()
turn_counts.rename(columns={'turn_changed': 'turn_count'}, inplace=True)

# 5. ì›ë³¸ ë°ì´í„°í”„ë ˆì„ì— ë³‘í•©
calls_df = pd.merge(calls_df, turn_counts, on='recordId', how='left')

print("âœ… 'turn_count' íŠ¹ì§• ìƒì„± ë° ë³‘í•© ì™„ë£Œ!")

# --- ê²°ê³¼ í™•ì¸ ---
# ê¸´ê¸‰ë„ë³„ í‰ê·  í„´ ì „í™˜ íšŸìˆ˜ë¥¼ ì¶œë ¥í•˜ì—¬ ê°€ì„¤ì„ 1ì°¨ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
print("\n--- ê¸´ê¸‰ë„ë³„ í‰ê·  ëŒ€í™” í„´ ì „í™˜ íšŸìˆ˜ ---")
urgency_turn_mean = calls_df.groupby('urgencyLevel')['turn_count'].mean().sort_values(ascending=False)
print(urgency_turn_mean)

print("\n--- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (turn_count ì¶”ê°€ í™•ì¸) ---")
print(calls_df.head())

# %% [EDA] 3. ìˆ˜ë³´ì ì´ˆê¸° ì‘ë‹µ ì‹œê°„ ê³„ì‚°

# 1. ê° í†µí™”ë³„ë¡œ ì‹ ê³ ì(1)ì™€ ìˆ˜ë³´ì(0)ì˜ ì²« ë°œí™” ì •ë³´ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì¶”ì¶œí•©ë‹ˆë‹¤.
# utts_df_sortedëŠ” ì´ì „ ë‹¨ê³„ì—ì„œ ì´ë¯¸ ì •ë ¬ë˜ì—ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
first_caller_utt = utts_df_sorted[utts_df_sorted['speaker'] == 1].drop_duplicates('recordId', keep='first')[['recordId', 'endAt']]
first_agent_utt = utts_df_sorted[utts_df_sorted['speaker'] == 0].drop_duplicates('recordId', keep='first')[['recordId', 'startAt']]

# ë¶„ì„ì— ìš©ì´í•˜ë„ë¡ ì»¬ëŸ¼ ì´ë¦„ì„ ë³€ê²½í•©ë‹ˆë‹¤.
first_caller_utt.rename(columns={'endAt': 'caller_first_end'}, inplace=True)
first_agent_utt.rename(columns={'startAt': 'agent_first_start'}, inplace=True)

# 2. ì‹ ê³ ìì™€ ìˆ˜ë³´ìì˜ ì²« ë°œí™” ì •ë³´ë¥¼ 'recordId'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©í•©ë‹ˆë‹¤.
response_time_df = pd.merge(first_caller_utt, first_agent_utt, on='recordId')

# 3. 'ì´ˆê¸° ì‘ë‹µ ì‹œê°„'ì„ ê³„ì‚°í•©ë‹ˆë‹¤. (ìˆ˜ë³´ì ì²« ë°œí™” ì‹œì‘ ì‹œê°„ - ì‹ ê³ ì ì²« ë°œí™” ì¢…ë£Œ ì‹œê°„)
response_time_df['initial_response_ms'] = response_time_df['agent_first_start'] - response_time_df['caller_first_end']

# 4. ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
# ì‘ë‹µ ì‹œê°„ì´ 0ë³´ë‹¤ ì‘ì€ ê²½ìš°ëŠ” ìˆ˜ë³´ìê°€ ë¨¼ì € ë§í•œ ê²½ìš°ì´ë¯€ë¡œ ë¶„ì„ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.
valid_response_df = response_time_df[response_time_df['initial_response_ms'] >= 0].copy()

# 5. ì›ë³¸ ë°ì´í„°í”„ë ˆì„ì— ë³‘í•©í•©ë‹ˆë‹¤.
calls_df = pd.merge(calls_df, valid_response_df[['recordId', 'initial_response_ms']], on='recordId', how='left')

print("âœ… 'initial_response_ms' íŠ¹ì§• ìƒì„± ë° ë³‘í•© ì™„ë£Œ!")

# --- ê²°ê³¼ í™•ì¸ ---
# ê¸´ê¸‰ë„ë³„ í‰ê·  ì´ˆê¸° ì‘ë‹µ ì‹œê°„ì„ ì¶œë ¥í•˜ì—¬ ê°€ì„¤ì„ í™•ì¸í•©ë‹ˆë‹¤.
print("\n--- ê¸´ê¸‰ë„ë³„ í‰ê·  ì´ˆê¸° ì‘ë‹µ ì‹œê°„ (ms) ---")
urgency_response_mean = calls_df.groupby('urgencyLevel')['initial_response_ms'].mean().sort_values()
print(urgency_response_mean.map('{:.2f}ms'.format))

print("\n--- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (initial_response_ms ì¶”ê°€ í™•ì¸) ---")
print(calls_df.head())

# %% [EDA] 4. ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨ ê³„ì‚°
import numpy as np # <-- ë¹ ì¡Œë˜ import êµ¬ë¬¸ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

# 1. ê° ë°œí™”ì˜ ê¸¸ì´(duration_ms)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
utts_df['duration_ms'] = utts_df['endAt'] - utts_df['startAt']

# 2. í†µí™”(recordId) ë° í™”ì(speaker)ë³„ë¡œ ì´ ë°œí™” ì‹œê°„ì„ ì§‘ê³„í•©ë‹ˆë‹¤.
speaker_duration = utts_df.groupby(['recordId', 'speaker'])['duration_ms'].sum()

# 3. ì§‘ê³„ëœ ë°ì´í„°ë¥¼ unstack()ì„ ì´ìš©í•´ ë„“ì€ í˜•íƒœë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
speaker_duration_df = speaker_duration.unstack(fill_value=0)

# ë°ì´í„°ì…‹ ëª…ì„¸ì„œì— ë”°ë¼ 0ì€ ìˆ˜ë³´ì, 1ì€ ì‹ ê³ ìì…ë‹ˆë‹¤.
# speaker_duration_dfì— '0' ë˜ëŠ” '1' ì»¬ëŸ¼ë§Œ ìˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
if 0 not in speaker_duration_df.columns:
    speaker_duration_df[0] = 0
if 1 not in speaker_duration_df.columns:
    speaker_duration_df[1] = 0
speaker_duration_df.rename(columns={0: 'agent_duration', 1: 'caller_duration'}, inplace=True)


# 4. ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨(caller_talk_ratio)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
total_duration = speaker_duration_df['agent_duration'] + speaker_duration_df['caller_duration']
# 0ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ total_durationì´ 0ì¸ ê²½ìš° NaNìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ë‚˜ì¤‘ì— 0ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
speaker_duration_df['caller_talk_ratio'] = (speaker_duration_df['caller_duration'] / total_duration).replace([np.inf, -np.inf], np.nan)


# 5. ì›ë³¸ ë°ì´í„°í”„ë ˆì„ì— ë³‘í•©í•©ë‹ˆë‹¤.
calls_df = pd.merge(calls_df, speaker_duration_df[['caller_talk_ratio']], on='recordId', how='left')
calls_df['caller_talk_ratio'] = calls_df['caller_talk_ratio'].fillna(0) # ê²°ì¸¡ì¹˜ë¥¼ 0ìœ¼ë¡œ ì²˜ë¦¬

print("âœ… 'caller_talk_ratio' íŠ¹ì§• ìƒì„± ë° ë³‘í•© ì™„ë£Œ!")

# --- ê²°ê³¼ í™•ì¸ ---
# ê¸´ê¸‰ë„ë³„ í‰ê·  ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨ì„ ë°±ë¶„ìœ¨(%)ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
print("\n--- ê¸´ê¸‰ë„ë³„ í‰ê·  ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨ ---")
urgency_ratio_mean = calls_df.groupby('urgencyLevel')['caller_talk_ratio'].mean().sort_values(ascending=False)
print((urgency_ratio_mean * 100).map('{:.2f}%'.format))

print("\n--- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (caller_talk_ratio ì¶”ê°€ í™•ì¸) ---")
print(calls_df.head())

# %% [EDA] 5. ì¢…í•© ì‹œê°í™” (Box Plots with Korean Font)
!pip install -q koreanize-matplotlib

import seaborn as sns
import matplotlib.pyplot as plt
import koreanize_matplotlib

# ê²½ê³  ë©”ì‹œì§€ ë¬´ì‹œ (ì„ íƒ ì‚¬í•­)
import warnings
warnings.filterwarnings('ignore')

print("ğŸ“Š ìƒì„±ëœ 3ê°€ì§€ íŠ¹ì§•ì„ ê¸´ê¸‰ë„ë³„ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.\n")

# 1. ì‹œê°í™”ë¥¼ ìœ„í•œ Figureì™€ Axes ì¤€ë¹„
fig, axes = plt.subplots(1, 3, figsize=(20, 6))
fig.suptitle('ê¸´ê¸‰ë„ë³„ ëŒ€í™” íŒ¨í„´ íŠ¹ì§• ë¶„í¬', fontsize=16)

# ë¶„ì„ì˜ ì¼ê´€ì„±ì„ ìœ„í•´ ê¸´ê¸‰ë„ ìˆœì„œë¥¼ ('í•˜', 'ì¤‘', 'ìƒ')ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
urgency_order = ['í•˜', 'ì¤‘', 'ìƒ']

# 2. ì²« ë²ˆì§¸ ê·¸ë˜í”„: ëŒ€í™” í„´ ì „í™˜ íšŸìˆ˜
sns.boxplot(x='urgencyLevel', y='turn_count', data=calls_df, ax=axes[0], order=urgency_order)
axes[0].set_title('ëŒ€í™” í„´ ì „í™˜ íšŸìˆ˜', fontsize=14)
axes[0].set_xlabel('ê¸´ê¸‰ë„')
axes[0].set_ylabel('íšŸìˆ˜')

# 3. ë‘ ë²ˆì§¸ ê·¸ë˜í”„: ì´ˆê¸° ì‘ë‹µ ì‹œê°„
sns.boxplot(x='urgencyLevel', y='initial_response_ms', data=calls_df, ax=axes[1], order=urgency_order)
axes[1].set_title('ìˆ˜ë³´ì ì´ˆê¸° ì‘ë‹µ ì‹œê°„', fontsize=14)
axes[1].set_xlabel('ê¸´ê¸‰ë„')
axes[1].set_ylabel('ì‹œê°„ (ms)')
# Yì¶• ë²”ìœ„ë¥¼ ì¡°ì •í•˜ì—¬ ì´ìƒì¹˜ ë•Œë¬¸ì— ë¶„í¬ê°€ ì˜ ì•ˆ ë³´ì´ëŠ” í˜„ìƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
if not calls_df['initial_response_ms'].dropna().empty:
    p95 = calls_df['initial_response_ms'].quantile(0.95)
    axes[1].set_ylim(0, p95)

# 4. ì„¸ ë²ˆì§¸ ê·¸ë˜í”„: ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨
sns.boxplot(x='urgencyLevel', y='caller_talk_ratio', data=calls_df, ax=axes[2], order=urgency_order)
axes[2].set_title('ì‹ ê³ ì ë°œí™” ì ìœ ìœ¨', fontsize=14)
axes[2].set_xlabel('ê¸´ê¸‰ë„')
axes[2].set_ylabel('ë¹„ìœ¨ (%)')
axes[2].set_yticklabels([f'{y:.0%}' for y in axes[2].get_yticks()])

# ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒì„ ë³´ê¸° ì¢‹ê²Œ ì¡°ì •í•˜ê³  ì¶œë ¥í•©ë‹ˆë‹¤.
plt.tight_layout(rect=[0, 0.03, 1, 0.95])
plt.show()

# 1ë‹¨ê³„ì—ì„œ ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
# ê²°ê³¼ë¥¼ ì €ì¥í•  í´ë”ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
PROCESSED_DIR = "/content/drive/MyDrive/project1/Processed_Data"
os.makedirs(PROCESSED_DIR, exist_ok=True)

calls_df.to_feather(os.path.join(PROCESSED_DIR, 'calls_df_preprocessed.feather'))
utts_df.to_feather(os.path.join(PROCESSED_DIR, 'utts_df_preprocessed.feather'))

print(f"âœ… ì „ì²˜ë¦¬ëœ ë°ì´í„°í”„ë ˆì„ì´ '{PROCESSED_DIR}'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")